(window.webpackJsonp=window.webpackJsonp||[]).push([[552],{503:function(e,n,s){"use strict";s.r(n);var a=s(2),r=Object(a.a)({},function(){var e=this,n=e.$createElement,s=e._self._c||n;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"使用-gitlab-runner-docker"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用-gitlab-runner-docker","aria-hidden":"true"}},[e._v("#")]),e._v(" 使用 GitLab Runner Docker")]),e._v(" "),s("h2",{attrs:{id:"本节视频"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#本节视频","aria-hidden":"true"}},[e._v("#")]),e._v(" 本节视频")]),e._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://www.bilibili.com/video/av28384215",target:"_blank",rel:"noopener noreferrer"}},[e._v("【视频】项目实战-iToken-部署持续集成-使用 GitLab Runner Docker"),s("OutboundLink")],1)]),e._v(" "),s("li",[s("a",{attrs:{href:"https://www.bilibili.com/video/av28384268",target:"_blank",rel:"noopener noreferrer"}},[e._v("【视频】项目实战-iToken-部署持续集成-第一个 GitLab Runner 脚本"),s("OutboundLink")],1)]),e._v(" "),s("li",[s("a",{attrs:{href:"https://www.bilibili.com/video/av28384251",target:"_blank",rel:"noopener noreferrer"}},[e._v("【视频】项目实战-iToken-部署持续集成-实战分布式配置中心"),s("OutboundLink")],1)]),e._v(" "),s("li",[s("a",{attrs:{href:"https://www.bilibili.com/video/av28384230",target:"_blank",rel:"noopener noreferrer"}},[e._v("【视频】项目实战-iToken-部署持续集成-实战服务注册与发现"),s("OutboundLink")],1)])]),e._v(" "),s("h2",{attrs:{id:"概述"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#概述","aria-hidden":"true"}},[e._v("#")]),e._v(" 概述")]),e._v(" "),s("p",[e._v("为了配置方便，我们使用 "),s("code",[e._v("docker")]),e._v(" 来部署 "),s("code",[e._v("GitLab Runner")])]),e._v(" "),s("h2",{attrs:{id:"环境准备"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#环境准备","aria-hidden":"true"}},[e._v("#")]),e._v(" 环境准备")]),e._v(" "),s("ul",[s("li",[e._v("创建工作目录 "),s("code",[e._v("/usr/local/docker/runner")])]),e._v(" "),s("li",[e._v("创建构建目录 "),s("code",[e._v("/usr/local/docker/runner/environment")])]),e._v(" "),s("li",[e._v("下载 "),s("code",[e._v("jdk-8u152-linux-x64.tar.gz")]),e._v(" 并复制到 "),s("code",[e._v("/usr/local/docker/runner/environment")])])]),e._v(" "),s("h2",{attrs:{id:"dockerfile"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#dockerfile","aria-hidden":"true"}},[e._v("#")]),e._v(" Dockerfile")]),e._v(" "),s("p",[e._v("在 "),s("code",[e._v("/usr/local/docker/runner/environment")]),e._v(" 目录下创建 "),s("code",[e._v("Dockerfile")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("FROM gitlab/gitlab-runner:v11.0.2\nMAINTAINER Lusifer <topsale@vip.qq.com>\n\n# 修改软件源\nRUN echo 'deb http://mirrors.aliyun.com/ubuntu/ xenial main restricted universe multiverse' > /etc/apt/sources.list && \\\n    echo 'deb http://mirrors.aliyun.com/ubuntu/ xenial-security main restricted universe multiverse' >> /etc/apt/sources.list && \\\n    echo 'deb http://mirrors.aliyun.com/ubuntu/ xenial-updates main restricted universe multiverse' >> /etc/apt/sources.list && \\\n    echo 'deb http://mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse' >> /etc/apt/sources.list && \\\n    apt-get update -y && \\\n    apt-get clean\n\n# 安装 Docker\nRUN apt-get -y install apt-transport-https ca-certificates curl software-properties-common && \\\n    curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | apt-key add - && \\\n    add-apt-repository \"deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable\" && \\\n    apt-get update -y && \\\n    apt-get install -y docker-ce\nCOPY daemon.json /etc/docker/daemon.json\n\n# 安装 Docker Compose\nWORKDIR /usr/local/bin\nRUN wget https://raw.githubusercontent.com/topsale/resources/master/docker/docker-compose\nRUN chmod +x docker-compose\n\n# 安装 Java\nRUN mkdir -p /usr/local/java\nWORKDIR /usr/local/java\nCOPY jdk-8u152-linux-x64.tar.gz /usr/local/java\nRUN tar -zxvf jdk-8u152-linux-x64.tar.gz && \\\n    rm -fr jdk-8u152-linux-x64.tar.gz\n\n# 安装 Maven\nRUN mkdir -p /usr/local/maven\nWORKDIR /usr/local/maven\nRUN wget https://raw.githubusercontent.com/topsale/resources/master/maven/apache-maven-3.5.3-bin.tar.gz\n# COPY apache-maven-3.5.3-bin.tar.gz /usr/local/maven\nRUN tar -zxvf apache-maven-3.5.3-bin.tar.gz && \\\n    rm -fr apache-maven-3.5.3-bin.tar.gz\n# COPY settings.xml /usr/local/maven/apache-maven-3.5.3/conf/settings.xml\n\n# 配置环境变量\nENV JAVA_HOME /usr/local/java/jdk1.8.0_152\nENV MAVEN_HOME /usr/local/maven/apache-maven-3.5.3\nENV PATH $PATH:$JAVA_HOME/bin:$MAVEN_HOME/bin\n\nWORKDIR /\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br"),s("span",{staticClass:"line-number"},[e._v("22")]),s("br"),s("span",{staticClass:"line-number"},[e._v("23")]),s("br"),s("span",{staticClass:"line-number"},[e._v("24")]),s("br"),s("span",{staticClass:"line-number"},[e._v("25")]),s("br"),s("span",{staticClass:"line-number"},[e._v("26")]),s("br"),s("span",{staticClass:"line-number"},[e._v("27")]),s("br"),s("span",{staticClass:"line-number"},[e._v("28")]),s("br"),s("span",{staticClass:"line-number"},[e._v("29")]),s("br"),s("span",{staticClass:"line-number"},[e._v("30")]),s("br"),s("span",{staticClass:"line-number"},[e._v("31")]),s("br"),s("span",{staticClass:"line-number"},[e._v("32")]),s("br"),s("span",{staticClass:"line-number"},[e._v("33")]),s("br"),s("span",{staticClass:"line-number"},[e._v("34")]),s("br"),s("span",{staticClass:"line-number"},[e._v("35")]),s("br"),s("span",{staticClass:"line-number"},[e._v("36")]),s("br"),s("span",{staticClass:"line-number"},[e._v("37")]),s("br"),s("span",{staticClass:"line-number"},[e._v("38")]),s("br"),s("span",{staticClass:"line-number"},[e._v("39")]),s("br"),s("span",{staticClass:"line-number"},[e._v("40")]),s("br"),s("span",{staticClass:"line-number"},[e._v("41")]),s("br"),s("span",{staticClass:"line-number"},[e._v("42")]),s("br"),s("span",{staticClass:"line-number"},[e._v("43")]),s("br"),s("span",{staticClass:"line-number"},[e._v("44")]),s("br"),s("span",{staticClass:"line-number"},[e._v("45")]),s("br"),s("span",{staticClass:"line-number"},[e._v("46")]),s("br")])]),s("h2",{attrs:{id:"daemon-json"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#daemon-json","aria-hidden":"true"}},[e._v("#")]),e._v(" daemon.json")]),e._v(" "),s("p",[e._v("在 "),s("code",[e._v("/usr/local/docker/runner/environment")]),e._v(" 目录下创建 "),s("code",[e._v("daemon.json")]),e._v("，用于配置加速器和仓库地址")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('{\n  "registry-mirrors": [\n    "https://registry.docker-cn.com"\n  ],\n  "insecure-registries": [\n    "192.168.75.131:5000"\n  ]\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br")])]),s("h2",{attrs:{id:"docker-compose-yml"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#docker-compose-yml","aria-hidden":"true"}},[e._v("#")]),e._v(" docker-compose.yml")]),e._v(" "),s("p",[e._v("在 "),s("code",[e._v("/usr/local/docker/runner")]),e._v(" 目录下创建 "),s("code",[e._v("docker-compose.yml")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("version: '3.1'\nservices:\n  gitlab-runner:\n    build: environment\n    restart: always\n    container_name: gitlab-runner\n    privileged: true\n    volumes:\n      - /usr/local/docker/runner/config:/etc/gitlab-runner\n      - /var/run/docker.sock:/var/run/docker.sock\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br")])]),s("h2",{attrs:{id:"注册-runner"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#注册-runner","aria-hidden":"true"}},[e._v("#")]),e._v(" 注册 Runner")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("docker exec -it gitlab-runner gitlab-runner register\n\n# 输入 GitLab 地址\nPlease enter the gitlab-ci coordinator URL (e.g. https://gitlab.com/):\nhttp://192.168.75.146:8080/\n\n# 输入 GitLab Token\nPlease enter the gitlab-ci token for this runner:\n1Lxq_f1NRfCfeNbE5WRh\n\n# 输入 Runner 的说明\nPlease enter the gitlab-ci description for this runner:\n可以为空\n\n# 设置 Tag，可以用于指定在构建规定的 tag 时触发 ci\nPlease enter the gitlab-ci tags for this runner (comma separated):\ndeploy\n\n# 这里选择 true ，可以用于代码上传后直接执行\nWhether to run untagged builds [true/false]:\ntrue\n\n# 这里选择 false，可以直接回车，默认为 false\nWhether to lock Runner to current project [true/false]:\nfalse\n\n# 选择 runner 执行器，这里我们选择的是 shell\nPlease enter the executor: virtualbox, docker+machine, parallels, shell, ssh, docker-ssh+machine, kubernetes, docker, docker-ssh:\nshell\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br"),s("span",{staticClass:"line-number"},[e._v("22")]),s("br"),s("span",{staticClass:"line-number"},[e._v("23")]),s("br"),s("span",{staticClass:"line-number"},[e._v("24")]),s("br"),s("span",{staticClass:"line-number"},[e._v("25")]),s("br"),s("span",{staticClass:"line-number"},[e._v("26")]),s("br"),s("span",{staticClass:"line-number"},[e._v("27")]),s("br"),s("span",{staticClass:"line-number"},[e._v("28")]),s("br"),s("span",{staticClass:"line-number"},[e._v("29")]),s("br")])]),s("h2",{attrs:{id:"附：项目配置-dockerfile-案例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#附：项目配置-dockerfile-案例","aria-hidden":"true"}},[e._v("#")]),e._v(" 附：项目配置 Dockerfile 案例")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('FROM openjdk:8-jre\n\nMAINTAINER Lusifer <topsale@vip.qq.com>\n\nENV APP_VERSION 1.0.0-SNAPSHOT\nENV DOCKERIZE_VERSION v0.6.1\nRUN wget https://github.com/jwilder/dockerize/releases/download/$DOCKERIZE_VERSION/dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz \\\n    && tar -C /usr/local/bin -xzvf dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz \\\n    && rm dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz\n\nRUN mkdir /app\n\nCOPY itoken-eureka-$APP_VERSION.jar /app/app.jar\nENTRYPOINT ["dockerize", "-timeout", "5m", "-wait", "tcp://192.168.75.128:8888", "java", "-Djava.security.egd=file:/dev/./urandom", "-jar", "/app/app.jar", "--spring.profiles.active=prod"]\n\nEXPOSE 8761\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br")])])])},[],!1,null,null,null);n.default=r.exports}}]);